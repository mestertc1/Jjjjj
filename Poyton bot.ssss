import telegram
from telegram.ext import Updater, CommandHandler, MessageHandler, Filters, ConversationHandler
import sqlite3
from datetime import datetime
import schedule
import time
import threading

# Ù…Ø±Ø§Ø­Ù„ Ù…Ú©Ø§Ù„Ù…Ù‡
ADD_PRODUCT, GET_USER_INFO, EDIT_USER_INFO = range(3)

# Ø¯ÛŒØªØ§Ø¨ÛŒØ³
conn = sqlite3.connect('bot_database.db', check_same_thread=False)
c = conn.cursor()
c.execute('''CREATE TABLE IF NOT EXISTS products 
             (id INTEGER PRIMARY KEY, name TEXT, description TEXT, image TEXT)''')
c.execute('''CREATE TABLE IF NOT EXISTS users 
             (id INTEGER PRIMARY KEY, first_name TEXT, last_name TEXT, phone TEXT, birth_date TEXT)''')
c.execute('''CREATE TABLE IF NOT EXISTS stats 
             (date TEXT, visits INTEGER)''')
conn.commit()

# ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡
CHANNELS = ['https://t.me/LuxZ3', 'https://t.me/poshakfrigg02']  # Ù†Ø§Ù… Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯
ADMIN_ID = 6682891691  # Ø¢ÛŒØ¯ÛŒ Ø¹Ø¯Ø¯ÛŒ Ø§Ø¯Ù…ÛŒÙ† Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯
TOKEN = '8037159516:AAFHApaPBLmubqrA-riWpTENYuOBweRsN_8'  # ØªÙˆÚ©Ù† Ø±Ø¨Ø§Øª Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯

updater = Updater(TOKEN, use_context=True)
dp = updater.dispatcher
bot = updater.bot

# Ø¨Ø±Ø±Ø³ÛŒ Ø¹Ø¶ÙˆÛŒØª Ø¯Ø± Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§
def check_membership(update, context):
    user_id = update.message.from_user.id
    for channel in CHANNELS:
        status = context.bot.get_chat_member(channel, user_id).status
        if status not in ['member', 'administrator', 'creator']:
            update.message.reply_text('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ø¯Ø± Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ø¹Ø¶Ùˆ Ø´ÙˆÛŒØ¯:\n' + '\n'.join(CHANNELS))
            return False
    return True

# Ø´Ø±ÙˆØ¹ Ø±Ø¨Ø§Øª
def start(update, context):
    if not check_membership(update, context):
        return ConversationHandler.END
    user_id = update.message.from_user.id
    today = datetime.now().strftime('%Y-%m-%d')
    c.execute("INSERT OR IGNORE INTO stats (date, visits) VALUES (?, 0)", (today,))
    c.execute("UPDATE stats SET visits = visits + 1 WHERE date = ?", (today,))
    conn.commit()
    
    keyboard = [[telegram.KeyboardButton("Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù…Ø­ØµÙˆÙ„Ø§Øª")],
                [telegram.KeyboardButton("ÙˆÛŒØ±Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø®ØµÛŒ")]]
    reply_markup = telegram.ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    update.message.reply_text('Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯! Ù„Ø·ÙØ§Ù‹ Ú¯Ø²ÛŒÙ†Ù‡ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:', reply_markup=reply_markup)
    
    # Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±
    c.execute("SELECT * FROM users WHERE id = ?", (user_id,))
    if not c.fetchone():
        update.message.reply_text('Ù„Ø·ÙØ§Ù‹ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:\nÙ†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯')
        return GET_USER_INFO
    return ConversationHandler.END

# Ù„ÛŒØ³Øª Ù…Ø­ØµÙˆÙ„Ø§Øª
def list_products(update, context):
    if not check_membership(update, context):
        return
    c.execute("SELECT id, name FROM products")
    products = c.fetchall()
    if not products:
        update.message.reply_text("Ù…Ø­ØµÙˆÙ„ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯!")
        return
    keyboard = [[telegram.KeyboardButton(f"{name}")] for id, name in products]
    reply_markup = telegram.ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    update.message.reply_text("Ù…Ø­ØµÙˆÙ„Ø§Øª Ù…ÙˆØ¬ÙˆØ¯:", reply_markup=reply_markup)

# Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª Ù…Ø­ØµÙˆÙ„
def show_product(update, context):
    if not check_membership(update, context):
        return
    product_name = update.message.text
    c.execute("SELECT name, description, image FROM products WHERE name = ?", (product_name,))
    product = c.fetchone()
    if product:
        name, desc, image = product
        update.message.reply_text(f"Ù†Ø§Ù…: {name}\nØªÙˆØ¶ÛŒØ­Ø§Øª: {desc}")
        if image:
            context.bot.send_photo(update.message.chat_id, image)
    else:
        update.message.reply_text("Ù…Ø­ØµÙˆÙ„ ÛŒØ§ÙØª Ù†Ø´Ø¯!")

# Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù…Ø­ØµÙˆÙ„ (ÙÙ‚Ø· Ø§Ø¯Ù…ÛŒÙ†)
def add_product(update, context):
    if update.message.from_user.id != ADMIN_ID:
        update.message.reply_text("Ø´Ù…Ø§ Ø§Ø¬Ø§Ø²Ù‡ Ø§ÛŒÙ† Ú©Ø§Ø± Ø±Ø§ Ù†Ø¯Ø§Ø±ÛŒØ¯!")
        return ConversationHandler.END
    update.message.reply_text("Ù†Ø§Ù… Ù…Ø­ØµÙˆÙ„ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:")
    return ADD_PRODUCT

def add_product_name(update, context):
    context.user_data['product_name'] = update.message.text
    update.message.reply_text("ØªÙˆØ¶ÛŒØ­Ø§Øª Ù…Ø­ØµÙˆÙ„ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:")
    return ADD_PRODUCT + 1

def add_product_desc(update, context):
    context.user_data['product_desc'] = update.message.text
    update.message.reply_text("Ù„Ø·ÙØ§Ù‹ ØªØµÙˆÛŒØ± Ù…Ø­ØµÙˆÙ„ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯ (ÛŒØ§ /skip Ø¨Ø±Ø§ÛŒ Ø±Ø¯ Ú©Ø±Ø¯Ù†):")
    return ADD_PRODUCT + 2

def add_product_image(update, context):
    if update.message.text == '/skip':
        image = None
    else:
        image = update.message.photo[-1].file_id
    c.execute("INSERT INTO products (name, description, image) VALUES (?, ?, ?)",
             (context.user_data['product_name'], context.user_data['product_desc'], image))
    conn.commit()
    update.message.reply_text("Ù…Ø­ØµÙˆÙ„ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯!")
    return ConversationHandler.END

# Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±
def get_user_info(update, context):
    user_id = update.message.from_user.id
    if 'first_name' not in context.user_data:
        context.user_data['first_name'] = update.message.text
        update.message.reply_text("Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:")
        return GET_USER_INFO + 1
    elif 'last_name' not in context.user_data:
        context.user_data['last_name'] = update.message.text
        update.message.reply_text("Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:")
        return GET_USER_INFO + 2
    elif 'phone' not in context.user_data:
        context.user_data['phone'] = update.message.text
        update.message.reply_text("ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯ Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª YYYY-MM-DD ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:")
        return GET_USER_INFO + 3
    else:
        birth_date = update.message.text
        c.execute("INSERT INTO users (id, first_name, last_name, phone, birth_date) VALUES (?, ?, ?, ?, ?)",
                 (user_id, context.user_data['first_name'], context.user_data['last_name'],
                  context.user_data['phone'], birth_date))
        conn.commit()
        update.message.reply_text("Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ù…Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯!")
        return start(update, context)

# ÙˆÛŒØ±Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±
def edit_user_info(update, context):
    if not check_membership(update, context):
        return
    user_id = update.message.from_user.id
    c.execute("SELECT * FROM users WHERE id = ?", (user_id,))
    user = c.fetchone()
    if user:
        update.message.reply_text(f"Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ¹Ù„ÛŒ:\nÙ†Ø§Ù…: {user[1]}\nÙ†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ: {user[2]}\nØªÙ„ÙÙ†: {user[3]}\nØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯: {user[4]}\nÚ†Ù‡ Ú†ÛŒØ²ÛŒ Ø±Ø§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯ØŸ (Ù†Ø§Ù…/Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ/ØªÙ„ÙÙ†/ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯)")
        return EDIT_USER_INFO
    return ConversationHandler.END

def process_edit(update, context):
    field = update.message.text
    context.user_data['edit_field'] = field
    update.message.reply_text(f"Ù…Ù‚Ø¯Ø§Ø± Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ {field} Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:")
    return EDIT_USER_INFO + 1

def save_edit(update, context):
    user_id = update.message.from_user.id
    new_value = update.message.text
    field = context.user_data['edit_field']
    field_map = {'Ù†Ø§Ù…': 'first_name', 'Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ': 'last_name', 'ØªÙ„ÙÙ†': 'phone', 'ØªØ§Ø±ÛŒØ® ØªÙˆÙ„Ø¯': 'birth_date'}
    c.execute("SELECT * FROM users WHERE id = ?", (user_id,))
    old_data = c.fetchone()
    c.execute(f"UPDATE users SET {field_map[field]} = ? WHERE id = ?", (new_value, user_id))
    conn.commit()
    c.execute("SELECT * FROM users WHERE id = ?", (user_id,))
    new_data = c.fetchone()
    context.bot.send_message(ADMIN_ID, f"ØªØºÛŒÛŒØ± Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±:\nÙ‚Ø¯ÛŒÙ…ÛŒ: {old_data[1:5]}\nØ¬Ø¯ÛŒØ¯: {new_data[1:5]}")
    update.message.reply_text("Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯!")
    return start(update, context)

# Ù†Ù…Ø§ÛŒØ´ Ø¢Ù…Ø§Ø± (ÙÙ‚Ø· Ø§Ø¯Ù…ÛŒÙ†)
def show_stats(update, context):
    if update.message.from_user.id != ADMIN_ID:
        return
    c.execute("SELECT * FROM stats")
    stats = c.fetchall()
    message = "Ø¢Ù…Ø§Ø± ÙˆØ±ÙˆØ¯:\n" + "\n".join([f"{date}: {visits} Ø¨Ø§Ø²Ø¯ÛŒØ¯" for date, visits in stats])
    c.execute("SELECT name FROM products")
    products = c.fetchall()
    message += "\n\nÙ…Ø­ØµÙˆÙ„Ø§Øª:\n" + "\n".join([f"{p[0]}" for p in products])
    c.execute("SELECT * FROM users")
    users = c.fetchall()
    message += "\n\nÚ©Ø§Ø±Ø¨Ø±Ø§Ù†:\n" + "\n".join([f"{u[1]} {u[2]} - {u[3]} - {u[4]}" for u in users])
    update.message.reply_text(message)

# Ø¨Ø±Ø±Ø³ÛŒ ØªÙˆÙ„Ø¯Ù‡Ø§ Ùˆ Ø§Ø±Ø³Ø§Ù„ ØªØ¨Ø±ÛŒÚ©
def check_birthdays():
    today = datetime.now().strftime('%m-%d')
    c.execute("SELECT id, first_name, birth_date FROM users WHERE strftime('%m-%d', birth_date) = ?", (today,))
    for user_id, first_name, _ in c.fetchall():
        bot.send_message(user_id, f"ØªÙˆÙ„Ø¯Øª Ù…Ø¨Ø§Ø±Ú© {first_name}! ğŸ‰ Ø§Ù…ÛŒØ¯ÙˆØ§Ø±Ù… Ø±ÙˆØ² ÙÙˆÙ‚â€ŒØ§Ù„Ø¹Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒ!")

# Ú¯Ø²Ø§Ø±Ø´ Ø±ÙˆØ²Ø§Ù†Ù‡ Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ†
def daily_report():
    today = datetime.now().strftime('%Y-%m-%d')
    c.execute("SELECT visits FROM stats WHERE date = ?", (today,))
    visits = c.fetchone()[0] if c.fetchone() else 0
    c.execute("SELECT * FROM users")
    users = c.fetchall()
    message = f"Ú¯Ø²Ø§Ø±Ø´ Ø±ÙˆØ²Ø§Ù†Ù‡ {today}:\nØ¨Ø§Ø²Ø¯ÛŒØ¯: {visits}\nÚ©Ø§Ø±Ø¨Ø±Ø§Ù†:\n" + "\n".join([f"{u[1]} {u[2]} - {u[3]} - {u[4]}" for u in users])
    bot.send_message(ADMIN_ID, message)

# Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ ÙˆØ¸Ø§ÛŒÙ
def schedule_tasks():
    schedule.every().day.at("00:00").do(check_birthdays)
    schedule.every().day.at("23:59").do(daily_report)
    while True:
        schedule.run_pending()
        time.sleep(60)

# Ù‡Ù†Ø¯Ù„Ø±Ù‡Ø§
dp.add_handler(CommandHandler("start", start))
dp.add_handler(CommandHandler("stats", show_stats))
dp.add_handler(ConversationHandler(
    entry_points=[CommandHandler("addproduct", add_product)],
    states={
        ADD_PRODUCT: [MessageHandler(Filters.text & ~Filters.command, add_product_name)],
        ADD_PRODUCT + 1: [MessageHandler(Filters.text & ~Filters.command, add_product_desc)],
        ADD_PRODUCT + 2: [MessageHandler(Filters.photo | Filters.text, add_product_image)]
    },
    fallbacks=[]
))
dp.add_handler(ConversationHandler(
    entry_points=[MessageHandler(Filters.regex("Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù…Ø­ØµÙˆÙ„Ø§Øª"), list_products),
                  MessageHandler(Filters.regex("ÙˆÛŒØ±Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø®ØµÛŒ"), edit_user_info)],
    states={
        GET_USER_INFO: [MessageHandler(Filters.text & ~Filters.command, get_user_info)],
        GET_USER_INFO + 1: [MessageHandler(Filters.text & ~Filters.command, get_user_info)],
        GET_USER_INFO + 2: [MessageHandler(Filters.text & ~Filters.command, get_user_info)],
        GET_USER_INFO + 3: [MessageHandler(Filters.text & ~Filters.command, get_user_info)],
        EDIT_USER_INFO: [MessageHandler(Filters.text & ~Filters.command, process_edit)],
        EDIT_USER_INFO + 1: [MessageHandler(Filters.text & ~Filters.command, save_edit)]
    },
    fallbacks=[]
))
dp.add_handler(MessageHandler(Filters.text & ~Filters.command, show_product))

# Ø´Ø±ÙˆØ¹ Ø±Ø¨Ø§Øª Ùˆ Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ
if name == 'main':
    threading.Thread(target=schedule_tasks, daemon=True).start()
    updater.start_polling()
    updater.idle()
